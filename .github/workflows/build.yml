name: Build

on:
  push:
    branches:
      - master
    tags:
      - nightly
      - 'v*'
      - 'exp*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  packages: write
  contents: write

jobs:
    build-windows:
        name: build-windows
        runs-on: windows-latest
        env: 
          USERNAME: cwi-dis
          VCPKG_EXE: ${{ github.workspace }}/vcpkg/vcpkg
          FEED_URL: https://nuget.pkg.github.com/cwi-dis/index.json
          VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/cwi-dis/index.json,readwrite"
          VCPKG_DEFAULT_TRIPLET: x64-windows-release
          VCPKG_INSTALL_OPTIONS: --x-abi-tools-use-exact-versions --debug
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REF_NAME_SAFE: unknown
        steps:
        - name: Santize ref name
          shell: bash
          run: |
                echo "GITHUB_REF_NAME_SAFE=${GITHUB_REF_NAME//\//-}" >> $GITHUB_ENV
        - name: Checkout code
          uses: actions/checkout@v3
          with:
                submodules: 'recursive'
                lfs: 'true'
                fetch-depth: 0
        - name: Get all tags
          run: |
                git show-ref --tags
                git log -40
                git describe
        - name: Install correct Python version
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'
        - name: Install OrbbecSDK
          shell: pwsh
          run: ./scripts/install-orbbecsdk-windows.ps1
        - name: Bootstrap vcpkg
          shell: pwsh
          run: ${{ github.workspace }}/vcpkg/bootstrap-vcpkg.bat

        - name: Add NuGet sources
          shell: pwsh
          run: |
            .$(${{ env.VCPKG_EXE }} fetch nuget) `
              sources add `
              -Source "${{ env.FEED_URL }}" `
              -StorePasswordInClearText `
              -Name GitHubPackages `
              -UserName "${{ env.USERNAME }}" `
              -Password "${{ github.token }}"
            .$(${{ env.VCPKG_EXE }} fetch nuget) `
              setapikey "${{ github.token }}" `
              -Source "${{ env.FEED_URL }}"

        - name: Install NSIS
          uses: repolevedavaj/install-nsis@v1.1.0
          with:
            nsis-version: '3.11'

        - name: Install thirdparty packages
          shell: pwsh
          run: scripts\install-3rdparty-windows.ps1

        - name: Install Python packages (Windows)
          shell: bash
          run: |
                ./scripts/install-3rdparty-windows.sh
                pythonExecutable=`which python`
                pythonRoot=`python -c "import sys ; print(sys.prefix)"`
                pythonExecutable=`cygpath --windows "$pythonExecutable"`
                echo "Python_ROOT_DIR=$pythonRoot" >> $GITHUB_ENV
                echo "Python3_EXECUTABLE=$pythonExecutable" >> $GITHUB_ENV
                
        - name: Print Path
          shell: pwsh
          run: |
               $env:path -split ";"


        - name: Install CMake
          uses: lukka/get-cmake@latest
          with:
            cmakeVersion: "~3.31.1"
        
        - name: Setup vcpkg
          uses: lukka/run-vcpkg@v11
            
        - name: CMake configure, build vcpkg packages, build & test
          uses: lukka/run-cmake@v10
          with:
            configurePreset: windows-production
            buildPreset: windows-production
            testPreset: windows-production
            #packagePreset: windows-production

        - name: Install with cmake
          shell: bash
          run: |
                cmake --install build --prefix '${{ github.workspace }}/installed'

        - name: Show Python and Python module versions used
          if: always()
          shell: bash
          run: |
                ./build/venv/Scripts/python --version
                ./build/venv/Scripts/python -m pip freeze
        - name: Create installer
          shell: bash
          run: |
                cpack --config build/CPackConfig.cmake
                ls -l build/package
        - name: upload CTest output in case of failure
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: windows-ctest-output
                path: build/Testing/Temporary/LastTest.log
        - name: Capture build folder as artifact
          if: ${{ failure() }}
          shell: bash
          run: tar cfz build.tar.gz build
        - name: Upload build folder
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: windows-build-folder
                path: build.tar.gz
        - name: Capture installed folder as artifact
          shell: bash
          run: |
                ls -lR installed
                7z a cwipc-windows-intel-built-${{ env.GITHUB_REF_NAME_SAFE }}.zip installed
        - name: Upload installed folder
          uses: actions/upload-artifact@v4
          with:
                name: cwipc-windows-intel-built-${{ env.GITHUB_REF_NAME_SAFE }}.zip
                path: cwipc-windows-intel-built-${{ env.GITHUB_REF_NAME_SAFE }}.zip
        - name: Upload nsis installer
          uses: actions/upload-artifact@v4
          with:
                name: cwipc-windows-intel-installer-${{ env.GITHUB_REF_NAME_SAFE }}.exe
                path: build/package/*.exe
        - name: Check what was created and installed
          if: always()
          shell: bash
          run: |
                ls -l /c
                ls -l /c/tools
                ls -l "/c/Program Files"
                ls -l "/c/Program Files (x86)"
                ls -l
                ls -l ..
                
    build-macos:
        name: build-macos
        runs-on: macos-latest
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REF_NAME_SAFE: ${{ github.ref_name }}
        steps:
        - name: Santize ref name
          shell: bash
          run: |
                echo "GITHUB_REF_NAME_SAFE=${GITHUB_REF_NAME//\//-}" >> $GITHUB_ENV
        - name: Checkout code
          uses: actions/checkout@v3
          with:
                submodules: 'recursive'
                lfs: 'true'
                fetch-depth: 0
        - name: Get all tags
          run: |
                git show-ref --tags
                git log -40
                git describe
        - name: Install dependencies
          shell: bash
          run: ./scripts/install-3rdparty-macos.sh
          env:
            HOMEBREW_NO_VERIFY_ATTESTATIONS: "1"
        - name: Install OrbbecSDK
          shell: bash
          run: ./scripts/install-orbbecsdk-macos.sh
        - name: Install CMake
          uses: lukka/get-cmake@latest
          with:
            cmakeVersion: "~3.31.1"
        
        - name: Setup vcpkg
          uses: lukka/run-vcpkg@v11
          if: false
            
        - name: CMake configure, build vcpkg packages, build & test
          uses: lukka/run-cmake@v10
          with:
            configurePreset: mac-production
            buildPreset: mac-production
            testPreset: mac-production
            #packagePreset: mac-production

        - name: Install with cmake
          shell: bash
          run: |
                cmake --install build --prefix ${{ github.workspace }}/installed

        - name: Show Python and Python module versions used
          if: always()
          shell: bash
          run: |
                ./build/venv/bin/python --version
                ./build/venv/bin/python -m pip freeze
        - name: Create installer
          shell: bash
          run: |
                cpack --config build/CPackConfig.cmake
                ls -l build/package
        - name: upload CTest output in case of failure
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: macos-ctest-output
                path: build/Testing/Temporary/LastTest.log
        - name: Capture build folder as artifact
          if: ${{ failure() }}
          shell: bash
          run: tar cfz build.tar.gz build
        - name: Upload build folder
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: macos-build-folder
                path: build.tar.gz
        - name: Capture installed folder as artifact
          shell: bash
          run: |
                tar cvfz cwipc-macos-arm64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz -C installed .
                ls -l
        - name: Upload installed folder
          uses: actions/upload-artifact@v4
          with:
                name: cwipc-macos-arm64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
                path: cwipc-macos-arm64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            
    build-android:
        name: build-android
        runs-on: ubuntu-latest
        env: 
          USERNAME: cwi-dis
          VCPKG_EXE: ${{ github.workspace }}/vcpkg/vcpkg
          FEED_URL: https://nuget.pkg.github.com/cwi-dis/index.json
          VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/cwi-dis/index.json,readwrite"
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REF_NAME_SAFE: ${{ github.ref_name }}
        steps:
        - name: Santize ref name
          shell: bash
          run: |
                echo "GITHUB_REF_NAME_SAFE=${GITHUB_REF_NAME//\//-}" >> $GITHUB_ENV
        - name: Checkout code
          uses: actions/checkout@v3
          with:
                submodules: 'recursive'
                lfs: 'true'
                fetch-depth: 0
        - name: Get all tags
          run: |
                git show-ref --tags
                git log -40
                git describe --debug
                git describe --tags --debug
        - name: Free some space
          run: |
                df -h 
                # Remove software and language runtimes we're not using
                sudo rm -rf \
                  "$AGENT_TOOLSDIRECTORY" \
                  /opt/google/chrome \
                  /opt/microsoft/msedge \
                  /opt/microsoft/powershell \
                  /opt/pipx \
                  /usr/lib/mono \
                  /usr/local/julia* \
                  /usr/local/lib/android \
                  /usr/local/lib/node_modules \
                  /usr/local/share/chromium \
                  /usr/local/share/powershell \
                  /usr/share/dotnet \
                  /usr/share/swift
                df -h 
        - name: Install Android NDK
          uses: nttld/setup-ndk@v1
          id: setup-ndk
          with:
            ndk-version: r27b
            add-to-path: true

        - name: Bootstrap vcpkg
          shell: bash
          run: ${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh

        - name: Install mono for nuget for vcpkg
          shell: bash
          run: sudo apt install mono-complete

        - name: Add NuGet sources
          shell: bash
          env: 
            VCPKG_EXE: ${{ github.workspace }}/vcpkg/vcpkg
            USERNAME: cwi-dis
            FEED_URL: https://nuget.pkg.github.com/cwi-dis/index.json
          run: |
            mono `${{ env.VCPKG_EXE }} fetch nuget | tail -n 1` \
              sources add \
              -Source "${{ env.FEED_URL }}" \
              -StorePasswordInClearText \
              -Name GitHubPackages \
              -UserName "${{ env.USERNAME }}" \
              -Password "${{ github.token }}"
            mono `${{ env.VCPKG_EXE }} fetch nuget | tail -n 1` \
              setapikey "${{ github.token }}" \
              -Source "${{ env.FEED_URL }}"

        - name: Install CMake
          uses: lukka/get-cmake@latest
          with:
            cmakeVersion: "~3.31.1"
        
        - name: Setup vcpkg
          uses: lukka/run-vcpkg@v11
            
        - name: CMake configure, build vcpkg packages, build & test
          uses: lukka/run-cmake@v10
          with:
            configurePreset: android-production
            buildPreset: android-production
            #testPreset: android-production
            #packagePreset: android-production
          env:
            ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        
        - name: Create installer
          shell: bash
          run: |
                cpack --config build/CPackConfig.cmake -D CPACK_PACKAGE_FILE_NAME="cwipc-android-arm64-package-${{ env.GITHUB_REF_NAME_SAFE }}"
                ls -l build/package
        
        - name: Capture build folder as artifact
          if: ${{ failure() }}
          shell: bash
          run: tar cfz build.tar.gz build
        - name: Upload build folder
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: android-build-folder
                path: build.tar.gz
        
        - name: Upload installer package
          uses: actions/upload-artifact@v4
          with:
            name: cwipc-android-arm64-package-${{ env.GITHUB_REF_NAME_SAFE }}
            path: build/package/*.tar.gz
    
    build-ubuntu2404:
        name: build-ubuntu2404
        runs-on: ubuntu-24.04
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REF_NAME_SAFE: ${{ github.ref_name }}
        steps:
        - name: Santize ref name
          shell: bash
          run: |
                echo "GITHUB_REF_NAME_SAFE=${GITHUB_REF_NAME//\//-}" >> $GITHUB_ENV
        - name: Checkout code
          uses: actions/checkout@v3
          with:
                submodules: 'recursive'
                lfs: 'true'
                fetch-depth: 0
        - name: Get all tags
          run: |
                git show-ref --tags
                git log -40
                git describe --debug
                git describe --tags --debug
        - name: Install dependencies
          shell: bash
          run: ./scripts/install-3rdparty-ubuntu2404.sh
        - name: Install OrbbecSDK
          shell: bash
          run: ./scripts/install-orbbecsdk-ubuntu2404.sh
        - name: Install CMake
          uses: lukka/get-cmake@latest
          with:
            cmakeVersion: "~3.31.1"
        
        - name: Setup vcpkg
          uses: lukka/run-vcpkg@v11
          if: false
            
        - name: CMake configure, build vcpkg packages, build & test
          uses: lukka/run-cmake@v10
          with:
            configurePreset: linux-production
            buildPreset: linux-production
            testPreset: linux-production
            #packagePreset: linux-production
        
        - name: Install with cmake
          shell: bash
          run: |
                cmake --install build --prefix ${{ github.workspace }}/installed
        - name: Show Python and Python module versions used
          if: always()
          shell: bash
          run: |
                python3 --version
                ./build/venv/bin/python --version
                ./build/venv/bin/python -m pip freeze
        - name: Create installer
          shell: bash
          run: |
                cpack --config build/CPackConfig.cmake -D CPACK_DEBIAN_FILE_NAME="cwipc-ubuntu2404-amd64-package-${{ env.GITHUB_REF_NAME_SAFE }}.deb"
                ls -l build/package
        - name: upload CTest output in case of failure
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: ubuntu2404-ctest-output
                path: build/Testing/Temporary/LastTest.log
        - name: Capture build folder as artifact
          if: ${{ failure() }}
          shell: bash
          run: tar cfz build.tar.gz build
        - name: Upload build folder
          if: ${{ failure() }}
          uses: actions/upload-artifact@v4
          with:
                name: ubuntu2404-build-folder
                path: build.tar.gz

        - name: Upload cached git version
          uses: actions/upload-artifact@v4
          with:
                name: cached-git-version
                path: .cachedgitversion.txt
                if-no-files-found: error
                include-hidden-files: true

        - name: Capture installed folder as artifact
          shell: bash
          run: |
                tar cvfz cwipc-ubuntu2404-amd64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz -C installed .
                ls -la
        - name: Upload installed folder
          uses: actions/upload-artifact@v4
          with:
                name: cwipc-ubuntu2404-amd64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
                path: cwipc-ubuntu2404-amd64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
        - name: Upload debian package
          uses: actions/upload-artifact@v4
          with:
                name: debian-package-2404.deb
                path: build/package/*.deb

    create-release:
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        name: create-release
        runs-on: ubuntu-latest
        needs:
            - build-windows
            - build-macos
            - build-ubuntu2404
            - build-android
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REF_NAME_SAFE: ${{ github.ref_name }}
        steps:
        - name: Santize ref name
          shell: bash
          run: |
                echo "GITHUB_REF_NAME_SAFE=${GITHUB_REF_NAME//\//-}" >> $GITHUB_ENV
        - name: Checkout code
          uses: actions/checkout@v2
          with:
                submodules: 'recursive'
                lfs: 'true'
                fetch-depth: 0
        - name: Get all tags
          run: |
                git show-ref --tags
                git log -40
                git describe
        - name: Download cached git version
          uses: actions/download-artifact@v4
          with:
                name: cached-git-version
                path: .
        - name: Create Assets and full sourcecode assets
          shell: bash
          run: |
                mkdir ../Assets
                tar cfz ../Assets/${{ env.GITHUB_REF_NAME_SAFE }}-complete.tar.gz --exclude-vcs .
                zip -x '*.git*' -r ../Assets/${{ env.GITHUB_REF_NAME_SAFE }}-complete.zip .
                awk '/^## /{if(flag){exit}; flag=1} flag' CHANGELOG.md > ../Assets/changes.md
        - name: Download Windows installed folder
          uses: actions/download-artifact@v4
          with:
                name: cwipc-windows-intel-built-${{ env.GITHUB_REF_NAME_SAFE }}.zip
                path: ../Assets/
        - name: Download Windows installer
          uses: actions/download-artifact@v4
          with:
                name: cwipc-windows-intel-installer-${{ env.GITHUB_REF_NAME_SAFE }}.exe
                path: ../Assets/
        - name: Download MacOS installed folder
          uses: actions/download-artifact@v4
          with:
                name: cwipc-macos-arm64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
                path: ../Assets/

        - name: Download Ubuntu 24.04 installed folder
          uses: actions/download-artifact@v4
          with:
                name: cwipc-ubuntu2404-amd64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
                path: ../Assets/
        - name: Download debian package for 24.04
          uses: actions/download-artifact@v4
          with:
                name: debian-package-2404.deb
                path: ../Assets/
        - name: Download Android installer
          uses: actions/download-artifact@v4
          with:
                name: cwipc-android-arm64-package-${{ env.GITHUB_REF_NAME_SAFE }}
                path: ../Assets/
        - name: Find Artefact names
          run: |
                windows_exe_path=$(ls ../Assets/*.exe | head -n 1)
                ubuntu2404_deb_path=$(ls ../Assets/*2404*.deb | head -n 1)
                echo "windows_exe_path=${windows_exe_path}" >> $GITHUB_ENV
                echo "ubuntu2404_deb_path=${ubuntu2404_deb_path}" >> $GITHUB_ENV
        - name: Check what is there
          shell: bash
          run: ls -l . ../Assets
        - name: Create Release
          uses: comnoco/create-release-action@v2.0.5
          id: create_release
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
                draft: false
                prerelease: true
                release_name: ${{ github.ref }}
                tag_name: ${{ github.ref }}
                body_path: ../Assets/changes.md

        - name: Upload Windows installer
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ${{ env.windows_exe_path }}
            asset_name: cwipc-windows-intel-installer-${{ env.GITHUB_REF_NAME_SAFE }}.exe
            asset_content_type: application/gzip
        
        - name: Upload Windows installed folder
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ../Assets/cwipc-windows-intel-built-${{ env.GITHUB_REF_NAME_SAFE }}.zip
            asset_name: cwipc-windows-intel-built-${{ env.GITHUB_REF_NAME_SAFE }}.zip
            asset_content_type: application/zip
        
        - name: Upload MacOS installed folder
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ../Assets/cwipc-macos-arm64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_name: cwipc-macos-arm64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_content_type: application/gzip

        - name: Upload Ubuntu 24.04 installed folder
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ../Assets/cwipc-ubuntu2404-amd64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_name: cwipc-ubuntu2404-amd64-built-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_content_type: application/gzip

        - name: Upload Ubuntu 24.04 debian package
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ${{ env.ubuntu2404_deb_path }}
            asset_name: cwipc-ubuntu2404-amd64-package-${{ env.GITHUB_REF_NAME_SAFE }}.deb
            asset_content_type: application/gzip

        - name: Upload Android package
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ../Assets/cwipc-android-arm64-package-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_name: cwipc-android-arm64-package-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_content_type: application/zip
        - name: Upload complete source (zip)
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ../Assets/${{ env.GITHUB_REF_NAME_SAFE }}-complete.zip
            asset_name: cwipc-fullsource-${{ env.GITHUB_REF_NAME_SAFE }}.zip
            asset_content_type: application/zip

        - name: Upload complete source (gzipped tar)
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ../Assets/${{ env.GITHUB_REF_NAME_SAFE }}-complete.tar.gz
            asset_name: cwipc-fullsource-${{ env.GITHUB_REF_NAME_SAFE }}.tar.gz
            asset_content_type: application/zip
